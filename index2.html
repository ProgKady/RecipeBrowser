<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kadysoft</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #5d5fef;
            --light: #f8f9ff;
            --text: #2d3748;
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family: 'Cairo', 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #f0f2ff 0%, #f8f9ff 100%);
            color: var(--text);
            min-height: 100vh; /* ØºÙŠØ±Øª Ù…Ù† height: 100vh Ø¥Ù„Ù‰ min-height */
            display: flex;
            flex-direction: column;
            /* Ø­Ø°Ù overflow: hidden ØªÙ…Ø§Ù…Ù‹Ø§ */
            -webkit-overflow-scrolling: touch; /* Ù…Ù‡Ù… Ø¬Ø¯Ù‹Ø§ Ù„Ù„Ø³ÙƒØ±ÙˆÙ„ Ø§Ù„Ø³Ù„Ø³ Ø¹Ù„Ù‰ iOS */
            touch-action: manipulation; /* ÙŠØ­Ø³Ù† Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ù„Ù…Ø³ */
        }
        header {
            background: white;
            padding: 18px 20px;
            box-shadow: 0 4px 20px rgba(93,95,239,0.12);
            font-size: 1.4em;
            font-weight: 800;
            color: var(--primary);
            text-align: center;
            position: relative;
            flex-shrink: 0;
        }
        .header-social {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
        }
        .header-social a {
            margin: 0 10px;
            color: var(--primary);
            font-size: 1.8em;
            transition: 0.3s;
        }
        .header-social a:hover { transform: scale(1.3); }
        .tab-bar {
            display: flex;
            background: white;
            border-bottom: 1px solid #eee;
            flex-shrink: 0;
        }
        .tab-btn {
            flex: 1;
            padding: 16px;
            text-align: center;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            transition: 0.3s;
        }
        .tab-btn.active {
            color: var(--primary);
            border-bottom: 4px solid var(--primary);
        }
        .tab-content {
            flex: 1;
            overflow: hidden;
            display: none;
            flex-direction: column;
        }
        .tab-content.active { display: flex; }
        .back-btn {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.6em;
            color: var(--primary);
            cursor: pointer;
            display: none;
            z-index: 10;
        }
        .breadcrumbs {
            padding: 12px 20px;
            background: white;
            font-size: 0.95em;
            color: #666;
            border-bottom: 1px solid #eee;
            white-space: nowrap;
            overflow-x: auto;
            flex-shrink: 0;
            -webkit-overflow-scrolling: touch;
        }
        .breadcrumbs span { color: var(--primary); font-weight: 600; cursor: pointer; }
        .content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            -webkit-overflow-scrolling: touch; /* Ù…Ø­Ø§ÙØ¸ Ø¹Ù„ÙŠÙ‡ */
            touch-action: pan-y; /* ÙŠØ³Ù…Ø­ Ø¨Ø§Ù„Ø³ÙƒØ±ÙˆÙ„ Ø§Ù„Ø±Ø£Ø³ÙŠ ÙÙ‚Ø· */
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 18px;
        }
        .item {
            background: white; border-radius: 16px; padding: 20px 16px; text-align: center;
            box-shadow: 0 8px 25px rgba(93,95,239,0.1); transition: all 0.3s cubic-bezier(0.4,0,0.2,1);
            cursor: pointer; user-select: none;
        }
        .item:hover { transform: translateY(-8px); box-shadow: 0 20px 40px rgba(93,95,239,0.2); }
        .item i { font-size: 2.8em; margin-bottom: 12px; color: var(--primary); }
        .item.folder i { color: #ffa502; }
        .item span { display: block; font-weight: 600; font-size: 1em; word-break: break-word; }
        #preview {
            position: fixed; top:0; left:0; right:0; bottom:0; background: white; z-index: 100;
            display: none; animation: slideIn 0.4s ease; flex-direction: column;
        }
        #preview iframe { width: 100%; height: calc(100% - 60px); border: none; }
        .preview-header {
            height: 60px; background: var(--primary); color: white;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; font-size: 1.2em; font-weight: bold;
        }
        .close-preview { font-size: 1.8em; cursor: pointer; }
        .add-container { padding: 30px 20px; max-width: 420px; margin: 0 auto; }
        .add-card {
            background: white;
            border-radius: 20px;
            padding: 30px 25px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(93,95,239,0.15);
        }
        .add-card h2 { color: var(--primary); margin-bottom: 25px; font-size: 1.5em; }
        .input-group { margin-bottom: 20px; position: relative; }
        .input-group input {
            width: 100%; padding: 16px; border: 2px solid #e0e4ff;
            border-radius: 12px; font-size: 1.1em; outline: none; transition: 0.3s;
        }
        .input-group input:focus { border-color: var(--primary); box-shadow: 0 0 0 4px rgba(93,95,239,0.1); }
        .input-group label {
            position: absolute; top: -10px; right: 15px; background: white;
            padding: 0 8px; font-size: 0.9em; color: var(--primary);
        }
        .submit-btn {
            background: var(--primary); color: white; border: none; width: 100%;
            padding: 16px; border-radius: 12px; font-size: 1.2em; font-weight: 600;
            cursor: pointer; transition: 0.3s;
        }
        .submit-btn:hover { transform: translateY(-3px); box-shadow: 0 10px 25px rgba(93,95,239,0.3); }
        #status { margin-top: 20px; font-weight: bold; font-size: 1.1em; }
        footer {
            background: white;
            padding: 12px;
            text-align: center;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.08);
            font-size: 0.85em;
            color: #666;
            user-select: none;
            flex-shrink: 0;
        }
        footer a { color: var(--primary); text-decoration: none; font-weight: 600; }
        footer a:hover { text-decoration: underline; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
    </style>
</head>
<body oncontextmenu="return false" onselectstart="return false" ondragstart="return false">
<header>
    RECETA
    <div class="header-social">
        <a href="https://facebook.com/kadinioo" target="_blank"><i class="fab fa-facebook"></i></a>
        <a href="https://wa.me/+201555266002" target="_blank"><i class="fab fa-whatsapp"></i></a>
    </div>
</header>
<div class="tab-bar">
    <div class="tab-btn active" onclick="openTab('recipes')">RECIPES</div>
    <div class="tab-btn" onclick="openTab('add')">SEND MODIFICATION</div>
</div>
<div id="recipes" class="tab-content active">
    <i class="fas fa-arrow-right back-btn" id="backBtn"></i>
    <div class="breadcrumbs" id="breadcrumbs">RECIPES</div>
    <div class="content">
        <div class="grid" id="grid"></div>
    </div>
    <div id="preview">
        <div class="preview-header">
    <span id="fileName">Ø¹Ø±Ø¶ Ø§Ù„Ø±ÙŠØ³ÙŠØ¨ÙŠ</span>
    <div>
        <i class="fas fa-image" id="exportPNG" title="ØªØµØ¯ÙŠØ± ØµÙˆØ±Ø©" style="margin-left:15px;cursor:pointer"></i>
        <i class="fas fa-times close-preview" id="closePreview"></i>
    </div>
</div>

        <iframe id="iframe"></iframe>
    </div>
</div>
<div id="add" class="tab-content">
    <div class="add-container">
        <div class="add-card">
            <h2>Ø§Ø¶Ø§ÙØ© ØµÙˆØ±Ø© Ù„Ù„Ø±ÙŠØ³ÙŠØ¨ÙŠ</h2>
            <div class="input-group">
                <input type="text" id="userName" required>
                <label>Ø§Ù„Ø§Ø³Ù…</label>
            </div>
            <div class="input-group">
                <input type="file" id="imageFile" accept="image/*" required>
                <label>Ø§Ø®ØªØ± Ø§Ù„ØµÙˆØ±Ø©</label>
            </div>
            <button class="submit-btn" onclick="submitForm()">Ø£Ø±Ø³Ù„ Ø§Ù„Ø±ÙŠØ³ÙŠØ¨ÙŠ</button>
            <div id="status"></div>
        </div>
    </div>
</div>
<footer>
    Â© 2026 <a href="#" onclick="openExternalLink('https://facebook.com/kadinioo')">Ahmed Elkady - Kadysoft Ltd.</a><br>
    <a href="#" onclick="openExternalLink('https://wa.me/201555266002')">Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨</a>
</footer>
<script>
// Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¬Ø§ÙØ§Ø³ÙƒØ±ÙŠØ¨Øª Ø²ÙŠ Ù…Ø§ Ù‡Ùˆ Ø¨Ø¯ÙˆÙ† Ø£ÙŠ ØªØºÙŠÙŠØ±
function openTab(tab) {
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(tab).classList.add('active');
    event.target.classList.add('active');
}
const owner = 'ProgKady', repo = 'Recipes', branch = 'master';
const api = `https://api.github.com/repos/${owner}/${repo}/contents`;
const raw = `https://raw.githubusercontent.com/${owner}/${repo}/${branch}`;
let history = [''];
const grid = document.getElementById('grid'), breadcrumbs = document.getElementById('breadcrumbs'),
    backBtn = document.getElementById('backBtn'), preview = document.getElementById('preview'),
    iframe = document.getElementById('iframe'), fileName = document.getElementById('fileName'),
    closePreview = document.getElementById('closePreview');
function decodeKS(t){
    return t.replace(/ï­/g,"9").replace(/ï­/g,"8").replace(/ï­Œ/g,"7").replace(/ï­‹/g,"6").replace(/ï­Š/g,"5")
            .replace(/ï­‰/g,"4").replace(/ï­ˆ/g,"3").replace(/ï­‡/g,"2").replace(/ï­†/g,"1").replace(/ï­„/g,"0")
            .replace(/ï­ƒ/g,"Z").replace(/ï­/g,"Y").replace(/ï­€/g,"X").replace(/ï¬¾/g,"W").replace(/ï¬¼/g,"V")
            .replace(/ï¬»/g,"U").replace(/ï¬º/g,"T").replace(/ï¬¹/g,"S").replace(/ï¬¸/g,"R").replace(/ï¬¶/g,"Q")
            .replace(/ï¬µ/g,"P").replace(/ï¬´/g,"O").replace(/ï¬³/g,"N").replace(/ï¬²/g,"M").replace(/ï¬±/g,"L")
            .replace(/ï¬°/g,"K").replace(/ï¬¯/g,"J").replace(/ï¬®/g,"I").replace(/ï¬­/g,"H").replace(/ï¬¬/g,"G")
            .replace(/ï¬«/g,"F").replace(/ï¬ª/g,"E").replace(/ï¬©/g,"D").replace(/ï¬¨/g,"C").replace(/ï¬§/g,"B")
            .replace(/ï¬¦/g,"A").replace(/&NBSP;/gi,"").replace(/[\u200B-\u200D\uFEFF]/g,"");
}
async function loadPath(p=''){
    const r = await fetch(`${api}/${p}?ref=${branch}`);
    let i = await r.json();
    i.sort((a,b) => b.type === 'dir' ? -1 : 1);
    grid.innerHTML = '';
    i.forEach(m => {
        let d = document.createElement('div');
        d.className = 'item ' + m.type;
        let icon = 'fa-file-code';
        if (m.type === 'dir') icon = 'fa-folder';
        else if (m.name.endsWith('.html')) icon = 'fa-file-code-alt';
        else if (m.name.endsWith('.xlsx') || m.name.endsWith('.xls')) icon = 'fa-file-excel';
        let displayName = m.name;
        if (m.name.endsWith('.ks')) displayName = m.name.replace('.ks', '');
        d.innerHTML = `<i class="fas ${icon}"></i><span>${displayName}</span>`;
        d.onclick = () => {
            if (m.type === 'dir') {
                history.push(m.path);
                updateBreadcrumbs();
                loadPath(m.path);
                backBtn.style.display = 'block';
            } else if (m.name.endsWith('.ks') || m.name.endsWith('.html') || m.name.endsWith('.xlsx') || m.name.endsWith('.xls')) {
                openPreview(m);
            }
        };
        grid.appendChild(d);
    });
}
function updateBreadcrumbs(){
    let p = history[history.length-1].split('/').filter(x => x);
    let h = 'RECIPES', c = '';
    p.forEach(x => { c += (c ? '/' : '') + x; h += ` <i class="fas fa-chevron-left"></i> <span onclick="goTo('${c}')">${x}</span>` });
    breadcrumbs.innerHTML = h;
}
function goTo(p){
    let i = history.findIndex(x => x === p);
    history = history.slice(0, i + 1);
    loadPath(p);
    backBtn.style.display = history.length > 1 ? 'block' : 'none';
    updateBreadcrumbs();
}
backBtn.onclick = () => {
    if (history.length > 1) {
        history.pop();
        loadPath(history[history.length - 1]);
        updateBreadcrumbs();
        if (history.length === 1) backBtn.style.display = 'none';
    }
}
function loadSheetJS() {
    return new Promise((resolve) => {
        if (window.XLSX) return resolve();
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
        script.onload = resolve;
        document.head.appendChild(script);
    });
}
async function openPreview(item){
    fileName.textContent = item.name;
    preview.style.display = 'block';
    iframe.srcdoc = `<h3 style='text-align:center;padding:80px;color:#999'>Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</h3>`;
    try {
        const fileUrl = `${raw}/${item.path}`;
        if (item.name.endsWith('.ks')) {
            let r = await fetch(fileUrl);
            let c = await r.text();
            let decoded = decodeKS(c);
            iframe.srcdoc = `<html><head><meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes"><style>body{margin:0;padding:0;overflow:auto;}</style></head><body>${decoded}</body></html>`;
        }
        else if (item.name.endsWith('.html')) {
            let r = await fetch(fileUrl);
            let htmlContent = await r.text();
            iframe.srcdoc = htmlContent;
        }
        else if (item.name.endsWith('.xlsx') || item.name.endsWith('.xls')) {
            await loadSheetJS();
            let r = await fetch(fileUrl);
            let arrayBuffer = await r.arrayBuffer();
            let workbook = XLSX.read(arrayBuffer, {type: 'array'});
            let firstSheetName = workbook.SheetNames[0];
            let worksheet = workbook.Sheets[firstSheetName];
            let htmlTable = XLSX.utils.sheet_to_html(worksheet);
            iframe.srcdoc = `
            <html>
              <head>
                <meta name="viewport" content="width=device-width, initial-scale=1">
                <style>
                  body { margin: 0; padding: 15px; font-family: 'Cairo', sans-serif; direction: ltr; background: #f8f9ff; overflow: auto; }
                  table { width: 100%; border-collapse: collapse; font-size: 14px; }
                  th, td { border: 1px solid #ddd; padding: 10px; text-align: right; }
                  th { background: #5d5fef; color: white; font-weight: bold; }
                  tr:nth-child(even) { background: #f9f9f9; }
                </style>
              </head>
              <body>
                <h3 style="text-align:center;color:#5d5fef;margin-bottom:20px;">${item.name} - ${firstSheetName}</h3>
                ${htmlTable}
              </body>
            </html>`;
        }
        setTimeout(() => {
            try {
                let d = iframe.contentDocument || iframe.contentWindow.document;
                if (d) {
                    let s = d.createElement("style");
                    s.innerHTML = `*{user-select:none !important}body{-webkit-touch-callout:none !important}`;
                    d.head.appendChild(s);
                    ["contextmenu","copy","cut","paste","selectstart","dragstart"].forEach(ev => d.addEventListener(ev, e => e.preventDefault()));
                }
            } catch(e) {}
        }, 1000);
    } catch(e) {
        iframe.srcdoc = '<h3 style="color:red;text-align:center;padding:100px">ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù</h3>';
    }
}
closePreview.onclick = () => {
    preview.style.display = 'none';
    iframe.srcdoc = '';
}
loadPath();
updateBreadcrumbs();
async function submitForm() {
    const name = document.getElementById('userName').value.trim();
    const file = document.getElementById('imageFile').files[0];
    const status = document.getElementById('status');
    if (!name || !file) { status.innerHTML = '<span style="color:#e74c3c">Ø§Ù…Ù„Ø£ ÙƒÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„</span>'; return; }
    status.innerHTML = '<span style="color:#3498db">Ø¬Ø§Ø±Ù Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...</span>';
    const fd = new FormData(); fd.append('file', file);
    try {
        const up = await fetch('https://tmpfiles.org/api/v1/upload', { method: 'POST', body: fd });
        const res = await up.json();
        const directLink = res.data.url.replace('/dl/', '/');
        const payload = { date: new Date().toLocaleString('ar-EG'), name, link: directLink };
        const webApp = 'https://script.google.com/macros/s/AKfycbzQEkfCOI_TLnHAzt9HMeQz4AH0CPJrleQA5NK-93S_ByZSFW16G-ngcW360rVbX-Yngg/exec';
        const sheet = await fetch(webApp, { method: 'POST', body: JSON.stringify(payload) });
        if (sheet.ok) {
            status.innerHTML = '<span style="color:#2ecc71">ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­!</span>';
            document.getElementById('userName').value = '';
            document.getElementById('imageFile').value = '';
        } else status.innerHTML = '<span style="color:#e74c3c">ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</span>';
    } catch (e) {
        status.innerHTML = '<span style="color:#e74c3c">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</span>';
    }
}
function openExternalLink(url) {
    window.location.href = "intent://" + url.replace(/^https?:\/\//, '') + "#Intent;package=com.android.chrome;scheme=https;end;";
}
</script>
<script>
/* =========================
   EXPORT PREVIEW AS PNG
   ========================= */

document.getElementById("exportPNG").onclick = async () => {
    try {
        const iframeEl = document.getElementById("iframe");
        const iframeDoc = iframeEl.contentDocument || iframeEl.contentWindow.document;

        if (!iframeDoc || !iframeDoc.body) {
            alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø­ØªÙˆÙ‰ Ù„Ù„ØªØµØ¯ÙŠØ±");
            return;
        }

        // ØªØµÙˆÙŠØ± Ø§Ù„Ù…Ø­ØªÙˆÙ‰
        const canvas = await html2canvas(iframeDoc.body, {
            scale: 2,
            useCORS: true,
            backgroundColor: "#ffffff"
        });

        // ØªØ­ÙˆÙŠÙ„ Ù„ØµÙˆØ±Ø©
        const imageData = canvas.toDataURL("image/png");

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©
        const link = document.createElement("a");
        link.href = imageData;
        link.download = (fileName.textContent || "preview") + ".png";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        // ÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨
        const msg = encodeURIComponent("Recipe Preview ğŸ“¸");
        window.open("https://wa.me/?text=" + msg, "_blank");

    } catch (err) {
        console.error(err);
        alert("ÙØ´Ù„ ØªØµØ¯ÙŠØ± Ø§Ù„ØµÙˆØ±Ø©");
    }
};
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</body>
</html>
